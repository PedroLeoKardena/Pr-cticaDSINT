//created on: 25 oct 2025
package rule1

//list any import classes here.
import java.util.List;
import java.util.Collections;
import java.util.Comparator;
import java.util.ArrayList;

import dominioECG.Persona;
import dominioECG.RegistroECG;
import dominioECG.Onda;
import dominioECG.OndaP;
import dominioECG.OndaQ;
import dominioECG.OndaR;
import dominioECG.OndaS;
import dominioECG.OndaT;
import dominioECG.Ciclo;

//declare any global variables here
global java.util.concurrent.atomic.AtomicInteger cicloContador;



rule "Print y Crear Registros Persona"
	no-loop true
    when
        $p: Persona();
    then
    	java.util.List<RegistroECG> registros = $p.getRegistroECG();
        for (RegistroECG reg : registros) {
	        System.out.println("Registro ID: " + reg.getIdRegistro());
	        System.out.println("Insertando registro clase: " + reg.getClass().getName());
	        insert(reg);
    	}
end

declare RegistroProcesado
    registroId : String
end

rule "Insertar ondas"
    when
        $r: RegistroECG();
        not RegistroProcesado( registroId == $r.getIdRegistro() )
    then
	    System.out.println("Insertamos ondas del registro con ID: " + $r.getIdRegistro());
	    List<Onda> ondas= $r.getOndasRegistro();

	    for (int i = 0; i < ondas.size() - 1; i++) {
	        insert(ondas.get(i));
	        //System.out.println(ondas.get(i).getCicloPertenece() == null);
	    }
		insert(new RegistroProcesado($r.getIdRegistro()));
end

//rule "Ver ondasQ"
//		no-loop true
//	when
//		$ondaQ : dominioECG.OndaQ();
//	then
//		System.out.println("OndaQ con start_time: " + $ondaQ.getStart_time());
//			
//end

rule "Crear ciclos"
		no-loop true
	when
        // Capturamos un registro para usarlo en todos los filtros
        $registro : RegistroECG()
        
        
        //Contamos numero de ciclos:
        //$numCiclos : Number() from accumulate (
		//	Ciclo( registroPertenece == $registro ),
		//	count( 1 )
		//)
	    
		// Encontramos OndaP
        // Debe ser del registro, sin ciclo asociado. Guardamos el start time y el end time para hacer 
        //comprobaciones con ondaQ
        $p : OndaP(
                registroPertenece == $registro, // Debe pertenecer a este $registro
                cicloPertenece == null
              )
        
        // Encontramos OndaQ (margen 70-120ms desde inicio OndaP)
       	$q : OndaQ(
                registroPertenece == $registro, // Mismo registro
                cicloPertenece == null
              )
              
        // Encontramos OndaR (margen Q-R: ±5ms)
        $r : OndaR(
                registroPertenece == $registro, // Mismo registro
                cicloPertenece == null
              )
              
        // Encontramos OndaS (margen R-S: ±5ms) 
        $s : OndaS(
                registroPertenece == $registro, // Mismo registro
                cicloPertenece == null
              )
        
        // Encontramos OndaT (margen S-T: ±5ms)
        $t : OndaT(
                registroPertenece == $registro, // Mismo registro
                cicloPertenece == null
              )     
         
	then	
		//System.out.println($numCiclos.intValue());	
		int nCiclos = cicloContador.incrementAndGet();
        System.out.println(" Creando Ciclo " + nCiclos + " para el registro " + $registro.getIdRegistro() + ".");
        
		Ciclo ciclo = new Ciclo();
		
		ciclo.setWaveP($p);
		ciclo.setWaveQ($q);
		ciclo.setWaveR($r);
		ciclo.setWaveS($s);
		ciclo.setWaveT($t);
		ciclo.setCycle_number(nCiclos);
		
		ciclo.setRegistroPertenece($registro);
		
		modify($p){setCicloPertenece(ciclo)};
		modify($q){setCicloPertenece(ciclo)};
		modify($r){setCicloPertenece(ciclo)};
		modify($s){setCicloPertenece(ciclo)};
		modify($t){setCicloPertenece(ciclo)};
		
		//Modificamos tambien registro, ya que le tenemos que meter el registro
		modify($registro){addCiclo(ciclo)};
		
				
		//Insertamos ciclo
		insert(ciclo);
end



		

